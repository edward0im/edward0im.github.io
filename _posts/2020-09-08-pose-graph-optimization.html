--- 
layout: post
title: (SLAM) Notes on Pose Graph Optimization with Codes
description: 
date: 2020-09-08
categories: [Engineering]
tag: [Engineering, SLAM, Pose Graph, Optimization, Loop Closing, Nonlinear Least Square]
use_math: true
comments: true
---
<nav id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgfe011ef">1. Introduction</a></li>
<li><a href="#org3834c7d">2. Pose Graph</a></li>
<li><a href="#org2dda22f">3. Pose Graph Optimization</a></li>
<li><a href="#org2c9fa8a">4. Code Review</a></li>
<li><a href="#org7352b84">5. References</a></li>
</ul>
</div>
</nav>


<div id="outline-container-orgfe011ef" class="outline-2">
<h2 id="orgfe011ef"><span class="section-number-2">1</span> Introduction</h2>
<div class="outline-text-2" id="text-1">
<p>
Pose Graph Optimization(PGO)은 로봇이 SLAM을 수행하면서 누적된 포즈 에러를 보정해주는 최적화 알고리즘 중 하나이다. 로봇이 SLAM을 수행하는 동안 센서로부터 계산되는 로봇의 포즈는 노이즈로 인해 필연적으로 에러를 포함하고 있는데 시간이 지날수록 에러는 누적되어 전체적인 Trajectroy가 어긋나게 된다.
</p>

<p>
이러한 문제를 해결하기 위해 1997년 Lu and Milios는 로봇의 포즈를 그래프 자료구조로 표현함으로써 최적화하는 Graph SLAM 방법을 제안하였는데 해당 방법에서 Back-end에 해당하는 부분이 Pose Graph Optimization이다. Graph SLAM의 Pipeline은 크게 Front-end와 Back-end로 구분할 수 있는데 로봇의 센서를 입력으로 받아 Pose Graph를 생성하는 부분을 Front-end라고 부르며 Front-end는 시간이 지날수록 노이즈로 인한 에러가 누적된다. 이러한 누적된 에러를 최적화하는 부분을 Back-end라고 부른다.
</p>


<figure>
<img src="/pictures/200908/01.png" alt="01.png" align="center" width="500px">

<figcaption><span class="figure-number">Figure 1: </span>Pose Graph-based SLAM System Pipeline. The image is from the freiburg university Robot Mapping lecture.</figcaption>
</figure>
</div>
</div>

<div id="outline-container-org3834c7d" class="outline-2">
<h2 id="org3834c7d"><span class="section-number-2">2</span> Pose Graph</h2>
<div class="outline-text-2" id="text-2">
<p>
Pose Graph는 로봇의 포즈를 자료구조 중 하나인 그래프로 표현한 SLAM에 특화된 자료구조를 의미한다. Pose Graph에서 노드는 로봇의 포즈(Pose)로 나타내고 엣지는 노드 사이의 상대 포즈(Relative Pose)로 나타낸다. 아래 그림은 Graph와 Pose Graph 자료구조의 차이점을 나타낸 그림이다.
</p>


<figure>
<img src="/pictures/200908/02.png" alt="02.png" align="center">

</figure>

<p>
본 포스팅에서는 3차원 SLAM에 관한 내용을 다루므로 Pose Graph에서 Pose $\mathbf{x}$와 Edge $\mathbf{z}$는 다음과 같이 정의된다.
</p>


<figure>
<img src="/pictures/200908/03.png" alt="03.png" align="center" width="300px">

</figure>

\begin{equation}
\begin{aligned}
\text{(Node) } \mathbf{x}_{i} &amp; = [x_{i} \ \  y_{i} \ \  z_{i} \ \  \alpha_{i} \ \  \beta_{i} \ \  \gamma_{i}]^{\intercal} \\
&amp; = \begin{bmatrix} \mathbf{R}_{i} &amp; \mathbf{t}_{i} \\ \mathbf{0} &amp; 1 \end{bmatrix}_{4\times 4}
\end{aligned}
\end{equation}
\begin{equation}
\begin{aligned}
\text{(Edge) } \mathbf{z}_{ij} &amp; = [x_{ij} \ \  y_{ij} \ \  z_{ij} \ \  \alpha_{ij} \ \  \beta_{ij} \ \  \gamma_{ij}]^{\intercal} \\
&amp; = \begin{bmatrix} \mathbf{R}_{ij} &amp; \mathbf{t}_{ij} \\ \mathbf{0} &amp; 1 \end{bmatrix}_{4\times 4} \\ 
\end{aligned}
\end{equation}
<p>
이 때, $\mathbf{x}_{i}$는 i번째 포즈를 의미하며 $\mathbf{z}_{ij}$는 노드 i,j 사이의 상대포즈를 의미한다.
</p>
</div>
</div>

<div id="outline-container-org2dda22f" class="outline-2">
<h2 id="org2dda22f"><span class="section-number-2">3</span> Pose Graph Optimization</h2>
<div class="outline-text-2" id="text-3">
<p>
Loop Closing과 같은 특수한 상황이 발생하면 Front-end에서 에러가 누적된 모든 노드와 엣지 정보를 Back-end로 전달하고 Back-end에서는 GICP 같은 방법을 사용하여 현재의 노드들의 관측값을 업데이트 해준 후 이전 스텝의 예측값과 차이(에러)가 가장 적은 Pose Graph가 되도록 최적화하는 과정을 수행한다. 이를 단계별로 정리하면 다음과 같다.
</p>

<ul class="org-ul">
<li>Loop Closing과 같은 특수한 상황 발생</li>
<li>Front-end에서 현재까지 에러가 누적된 모든 노드들과 엣지 정보를 Back-end로 전달</li>
<li>Back-end에서 GICP와 같은 방법을 통해 노드들의 관측값을 업데이트 (업데이트 전의 값들은 예측값으로 설정)</li>
<li>관측값과 예측값의 차이, 즉 에러가 최소가 되는 방향으로 에러함수를 최적화</li>
</ul>

<p>
이러한 과정을 Pose Graph Optimization (PGO)라고 하며 공식으로 표현하면 다음과 같다.
</p>

\begin{equation}
\begin{aligned}
\mathbf{x}^{*} = \arg\min_{\mathbf{x}} \| \mathbf{z} -  \hat{\mathbf{z}} \|^{2}_{\Sigma} = \| \mathbf{e} \|_{\Sigma}^{2}
\end{aligned}
\end{equation}
<p>
이 때, $\mathbf{x}= \begin{bmatrix}\mathbf{x}_{1} &amp; &ctdot; &amp; \mathbf{x}_{i} &amp; &ctdot; &amp; \mathbf{x}_{n}\end{bmatrix}^{\intercal}$는 로봇의 포즈 벡터를 의미하고 각각의 포즈 노드는 다음과 같다.
</p>

\begin{equation}
\begin{aligned}
    \mathbf{x}_{i} = \begin{bmatrix}
\mathbf{R}_{i} &amp; \mathbf{t}_{i} \\ 
0 &amp; 1
\end{bmatrix} \in \mathbb{R}^{4\times4}
\end{aligned}
\end{equation}
<p>
그리고 $\mathbf{z}$는 두 노드 사이의 GICP를 통해 업데이트된 상대포즈(관측값)을 의미하고 $\hat{\mathbf{z}}$는 두 노드 사이의 업데이트 전 상대포즈(예측값)을 의미한다. 관측값과 예측값의 차이를 에러함수 $\mathbf{e}$로 정의한다. 그리고 $\| \mathbf{e}\|_{&Sigma;}^{2}=\mathbf{e}^{\intercal}&Sigma;^{-1}\mathbf{e}=\mathbf{e}^{\intercal}&Omega; \mathbf{e}$를 의미한다.
</p>

<p>
PGO 공식을 순차적인 노드와 비순차적인 노드로 분리하면 다음과 같이 나타낼 수 있다.
</p>

\begin{equation}
\begin{aligned}
    \mathbf{x}^{*} = \arg\min_{\mathbf{x}} \sum_{i} \left \| \mathbf{z}_{i,i+1} -  \hat{\mathbf{z}}_{i,i+1} \right \|^{2}_{\Sigma_{i,i+1}} 
+ \sum_{i,j} \left \| \mathbf{z}_{i,j} - \hat{\mathbf{z}}_{i,j} \right \|^{2}_{\Sigma_{i,j}}
\end{aligned}
\end{equation}
<p>
이 때, $\mathbf{z}_{i,i+1}, \hat{\mathbf{z}}_{i,i+1}$은 순차적인 노드들 간 관측값 및 예측값을 의미하며 $\mathbf{z}_{i,j}, \hat{\mathbf{z}}_{i,j}$는 시간 순서와는 상관없는, 즉 비순차적인 노드들 간 관측값 및 예측값을 의미한다. PGO의 과정을 그림으로 순차적으로 나타내면 다음과 같다.
</p>


<figure>
<img src="/pictures/200908/04.png" alt="04.png" align="center" width="500px">

</figure>


<figure>
<img src="/pictures/200908/05.png" alt="05.png" align="center" width="500px">

</figure>


<figure>
<img src="/pictures/200908/06.png" alt="06.png" align="center" width="500px">

</figure>


<figure>
<img src="/pictures/200908/07.png" alt="07.png" align="center" width="500px">

</figure>


<figure>
<img src="/pictures/200908/08.png" alt="08.png" align="center" width="500px">

</figure>


<figure>
<img src="/pictures/200908/09.png" alt="09.png" align="center" width="500px">

</figure>


<figure>
<img src="/pictures/200908/10.png" alt="10.png" align="center" width="500px">

</figure>


<figure>
<img src="/pictures/200908/11.png" alt="11.png" align="center" width="500px">

</figure>


<figure>
<img src="/pictures/200908/12.png" alt="12.png" align="center" width="500px">

</figure>


<figure>
<img src="/pictures/200908/13.png" alt="13.png" align="center" width="500px">

</figure>


<figure>
<img src="/pictures/200908/14.png" alt="14.png" align="center" width="500px">

</figure>
</div>
</div>

<div id="outline-container-org2c9fa8a" class="outline-2">
<h2 id="org2c9fa8a"><span class="section-number-2">4</span> Code Review</h2>
</div>

<div id="outline-container-org7352b84" class="outline-2">
<h2 id="org7352b84"><span class="section-number-2">5</span> References</h2>
<div class="outline-text-2" id="text-5">
<p>
<a href="https://www.youtube.com/watch?v=_i8PaekcguA&amp;list=PLubUquiqNQdOTNocmWCSWk9ZaWhV7ubCD">Facebook SLAMKR Online Study Season 1</a>
</p>

<p>
<a href="https://youtu.be/wVsfCnyt5jA">Robot Mapping Course - Freiburg University</a>
</p>
</div>
</div>
